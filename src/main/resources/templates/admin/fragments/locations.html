<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<section th:fragment="locations" class="content-section">
    <div class="container-fluid">
        <div class="mx-auto" style="max-width: 1200px;">
        <!-- Header -->
        <div class="section-header mb-4">
            <h2><i class="fas fa-map-marker-alt me-2"></i>Gestión de Ubicaciones</h2>
            <p class="text-muted">Administra las diferentes zonas del establecimiento</p>
        </div>

        

        <!-- Header con botón (estilo events/users) -->
        <div class="events-header mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h4 class="section-subtitle mb-0">
                    Lista de Ubicaciones 
                    <span class="badge bg-primary" th:text="${locations.size()}"></span>
                </h4>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-primary rounded-pill shadow-sm px-3" data-bs-toggle="modal" data-bs-target="#addLocationModal">
                        <i class="fas fa-plus me-2"></i>Agregar Ubicación
                    </button>
                </div>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                <div class="d-flex flex-wrap gap-2 align-items-center" style="flex:1; min-width:260px;">
                    <div class="input-group" style="max-width: 360px;">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" id="locationsFilterInput" class="form-control" placeholder="Buscar ubicaciones...">
                    </div>
                </div>
                <div id="locationsPagination" class="btn-group" role="group" aria-label="Paginación"></div>
            </div>
        </div>

        <!-- Tabla -->
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Descripción</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="locationsTableBody">
                    <tr th:each="loc : ${locations}" data-row>
                        <td th:text="${loc.id}"></td>
                        <td><strong th:text="${loc.nombre}"></strong></td>
                        <td th:text="${loc.descripcion} ?: 'Sin descripción'"></td>
                        <td>
                            <div class="btn-actions d-flex gap-1">
                                <a th:href="@{/admin/locations/edit/{id}(id=${loc.id})}" class="btn btn-warning btn-sm" title="Editar ubicación">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button type="button" class="btn btn-danger btn-sm"
                                        th:attr="data-bs-target='#deleteModal'+${loc.id}"
                                        data-bs-toggle="modal"
                                        title="Eliminar ubicación">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    <tr th:if="${locations.empty}">
                        <td colspan="4" class="text-center py-4 text-muted">
                            <i class="fas fa-map-marker-alt fa-2x mb-3"></i>
                            <p>No hay ubicaciones registradas</p>
                            <p class="small">Comienza agregando tu primera ubicación</p>
                            <button type="button" class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#addLocationModal">
                                <i class="fas fa-plus me-2"></i>Agregar Primera Ubicación
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
		
	
        <div class="mx-auto" >
        <!-- Modal Agregar -->
		<!-- Modal Agregar Ubicación -->
		<div class="modal fade" id="addLocationModal" tabindex="-1">
		    <div class="modal-dialog">
		        <form th:action="@{/admin/locations/save}" method="post" class="modal-content">
		            <div class="modal-header bg-primary text-white">
		                <h5 class="modal-title">
		                    <i class="fas fa-plus-circle me-2"></i>Nueva Ubicación
		                </h5>
		                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
		            </div>
		            <div class="modal-body">
		                <input type="hidden" name="id">
		                <div class="mb-3">
		                    <label class="form-label required">Nombre de Ubicación</label>
		                    <input type="text" class="form-control" name="nombre" required
		                           placeholder="Terraza, Interior, Barra...">
		                </div>
		                <div class="mb-3">
		                    <label class="form-label">Descripción</label>
		                    <textarea class="form-control" name="descripcion" rows="2"
		                              placeholder="Descripción opcional..." maxlength="255"></textarea>
		                </div>
		            </div>
		            <div class="modal-footer">
		                <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">
		                    <i class="fas fa-times me-1"></i>Cancelar
		                </button>
		                <button type="submit" class="btn btn-primary rounded-pill">
		                    <i class="fas fa-save me-1"></i>Guardar Ubicación
		                </button>
		            </div>
		        </form>
		    </div>
		</div>

    <!-- Modales de eliminación (fuera de la tabla) -->
    <div th:each="loc : ${locations}">
        <div class="modal fade" th:id="'deleteModal'+${loc.id}" tabindex="-1">
            <div class="modal-dialog" style="margin-top:10vh">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-trash me-2"></i>Confirmar Eliminación</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>¿Está seguro de eliminar la ubicación <strong th:text="${loc.nombre}"></strong>?</p>
                        <p class="text-muted">Esta acción no se puede deshacer.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <a th:href="@{/admin/locations/delete/{id}(id=${loc.id})}" class="btn btn-danger">
                            <i class="fas fa-trash me-2"></i>Eliminar
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar -->
    <div th:if="${location.id != null}" class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog" style="margin-top:8vh">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Editar Ubicación</h5>
                    <a th:href="@{/admin/locations/cancel}" class="btn-close"></a>
                </div>
                <form th:action="@{/admin/locations/save}" th:object="${location}" method="post">
                    <div class="modal-body">
                        <input type="hidden" th:field="*{id}">
                        <div class="mb-3">
                            <label class="form-label required">Nombre de Ubicación</label>
                            <input type="text" class="form-control" th:field="*{nombre}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descripción</label>
                            <textarea class="form-control" th:field="*{descripcion}" rows="2" maxlength="255"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <a th:href="@{/admin/locations/cancel}" class="btn btn-secondary">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Actualizar Ubicación
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div th:if="${location.id != null}" class="modal-backdrop fade show"></div>
        <script>
        (function(){
          const run = () => {
            const tbody = document.getElementById('locationsTableBody');
            const textInput = document.getElementById('locationsFilterInput');
            const pager = document.getElementById('locationsPagination');
            const pageSize = 6;
            const rows = Array.from(tbody ? tbody.querySelectorAll('tr[data-row]') : []);
            const emptyRow = tbody ? tbody.querySelector('tr:not([data-row])') : null;
            let filtered = rows.slice();
            let page = 1;

            function getText(row){
              const tds = row.querySelectorAll('td');
              const id = tds[0]?.innerText || '';
              const nombre = tds[1]?.innerText || '';
              const desc = tds[2]?.innerText || '';
              return (id+" "+nombre+" "+desc).toLowerCase();
            }

            function render(){
              rows.forEach(r => r.style.display = 'none');
              if (emptyRow) emptyRow.style.display = filtered.length ? 'none' : '';
              const total = filtered.length;
              const pages = Math.max(1, Math.ceil(total / pageSize));
              page = Math.min(page, pages);
              const start = (page - 1) * pageSize;
              const end = start + pageSize;
              filtered.slice(start, end).forEach(r => r.style.display = '');
              renderPager(pages, total);
            }

            function renderPager(pages, total){
              if (!pager) return;
              pager.innerHTML = '';
              if (total <= pageSize) return;
              const prev = document.createElement('button');
              prev.type='button'; prev.className='btn btn-outline-secondary'; prev.textContent='«';
              prev.disabled = page<=1; prev.onclick = ()=>{ page--; render(); };
              pager.appendChild(prev);
              for (let i=1;i<=pages;i++){
                const b=document.createElement('button');
                b.type='button'; b.className='btn '+(i===page?'btn-primary':'btn-outline-secondary');
                b.textContent=i; b.onclick=()=>{ page=i; render(); };
                pager.appendChild(b);
              }
              const next = document.createElement('button');
              next.type='button'; next.className='btn btn-outline-secondary'; next.textContent='»';
              next.disabled = page>=pages; next.onclick = ()=>{ page++; render(); };
              pager.appendChild(next);
            }

            function applyFilter(){
              const q = (textInput?.value || '').toLowerCase().trim();
              filtered = rows.filter(r => !q || getText(r).includes(q));
              page = 1; render();
            }

            textInput && textInput.addEventListener('input', applyFilter);
            render();
          };
          if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', run); else run();
        })();
        </script>
    </section>
    </body>
    </html>
