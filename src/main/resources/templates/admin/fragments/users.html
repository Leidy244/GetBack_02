<div th:fragment="users">
  <section class="content-section">
    <div class="container-fluid">

      <!-- Encabezado -->
      <div class="section-header mb-4">
        <h2><i class="fas fa-users me-2"></i>Gestión de Usuarios</h2>
        <p class="text-muted">Administra los usuarios registrados del sistema</p>
      </div>

      <!-- Mensajes Flash -->
      <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-2"></i>
        <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
      <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-circle me-2"></i>
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>

      <!-- Encabezado de tabla -->
      <div class="locations-header d-flex justify-content-between align-items-center mb-4">
        <h4 class="section-subtitle mb-0">
          Lista de Usuarios
          <span class="badge bg-primary ms-2" th:text="${users != null ? users.size() : 0}"></span>
        </h4>
        <button type="button" class="btn btn-primary btn-add-user" data-bs-toggle="modal"
                data-bs-target="#nuevoUsuarioModal">
          <i class="fas fa-user-plus me-2"></i>Agregar Usuario
        </button>
      </div>

      <!-- Tabla de Usuarios -->
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-dark text-center">
            <tr>
              <th>Rol</th>
              <th>Nombre</th>
              <th>Apellido</th>
              <th>Correo</th>
              <th>Teléfono</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="usuario : ${users}" class="text-center">
              <td th:text="${usuario.rol != null ? usuario.rol.nombre : '—'}"></td>
              <td th:text="${usuario.nombre}"></td>
              <td th:text="${usuario.apellido}"></td>
              <td th:text="${usuario.correo}"></td>
              <td th:text="${usuario.telefono ?: 'N/A'}"></td>
              <td>
                <span th:class="${usuario.estado == 'ACTIVO'} ? 'badge bg-success' : 'badge bg-danger'"
                      th:text="${usuario.estado}"></span>
              </td>
              <td>
                <div class="btn-group">

                  <!-- EDITAR: abre modal reutilizable, pasando datos via data-attributes Thymeleaf -->
                  <button type="button" class="btn btn-sm btn-warning btn-edit-user"
                          data-bs-toggle="modal"
                          data-bs-target="#editarUsuarioModal"
                          th:attr="data-user-id=${usuario.id},
                                   data-user-nombre=${usuario.nombre},
                                   data-user-apellido=${usuario.apellido},
                                   data-user-correo=${usuario.correo},
                                   data-user-telefono=${usuario.telefono},
                                   data-user-direccion=${usuario.direccion},
                                   data-user-estado=${usuario.estado},
                                   data-user-rol=${usuario.rol != null ? usuario.rol.id : ''}"
                          title="Editar">
                    <i class="fas fa-edit"></i>
                  </button>

                  <!-- TOGGLE STATUS (usa la URL que tengas en backend) -->
                  <a th:href="@{/users/toggle-status/{id}(id=${usuario.id})}"
                     th:class="${usuario.estado=='ACTIVO'} ? 'btn btn-sm btn-secondary' : 'btn btn-sm btn-success'"
                     th:title="${usuario.estado=='ACTIVO'} ? 'Desactivar' : 'Activar'">
                    <i th:class="${usuario.estado=='ACTIVO'} ? 'fas fa-toggle-off' : 'fas fa-toggle-on'"></i>
                  </a>

                  <!-- ELIMINAR: abre modal de confirmación. type="button" evita submit accidental -->
                  <button type="button"
                          class="btn btn-sm btn-danger btn-open-delete-modal"
                          data-bs-toggle="modal"
                          data-bs-target="#confirmDeleteUserModal"
                          th:attr="data-user-id=${usuario.id}, data-user-nombre=${usuario.nombre + ' ' + usuario.apellido}">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>

            <tr th:if="${users == null or users.isEmpty()}">
              <td colspan="7" class="text-center py-4 text-muted">
                <i class="fas fa-users fa-2x mb-3"></i>
                <p>No hay usuarios registrados.</p>
                <button type="button" class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#nuevoUsuarioModal">
                  <i class="fas fa-user-plus me-2"></i>Agregar Primer Usuario
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Modal Nuevo Usuario (igual que antes, usando th:object newUser) -->
    <div class="modal fade" id="nuevoUsuarioModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <form th:action="@{/users/save}" th:object="${newUser}" method="post">
            <div class="modal-header">
              <h5 class="modal-title"><i class="fas fa-user-plus me-2"></i>Nuevo Usuario</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label">Nombre *</label>
                  <input type="text" class="form-control" th:field="*{nombre}" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Apellido *</label>
                  <input type="text" class="form-control" th:field="*{apellido}" required>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label">Correo *</label>
                  <input type="email" class="form-control" th:field="*{correo}" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Contraseña *</label>
                  <input type="password" class="form-control" th:field="*{clave}" required>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label">Teléfono</label>
                  <input type="tel" class="form-control" th:field="*{telefono}">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Dirección</label>
                  <input type="text" class="form-control" th:field="*{direccion}">
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label">Estado</label>
                  <select class="form-select" th:field="*{estado}">
                    <option value="ACTIVO">Activo</option>
                    <option value="INACTIVO">Inactivo</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Rol</label>
                  <select class="form-select" th:field="*{rol.id}" required>
                    <option value="" disabled selected>Selecciona un rol</option>
                    <option th:each="rol : ${roles}" th:value="${rol.id}" th:text="${rol.nombre}"></option>
                  </select>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-primary"><i class="fas fa-save me-1"></i>Guardar Usuario</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal Editar Usuario (REUTILIZABLE - se llena con JS) -->
    <div class="modal fade" id="editarUsuarioModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <!-- Nota: aquí usamos campos con "name" que tu backend espera. Ajusta action si tu endpoint difiere -->
          <form id="formEditarUsuario" th:action="@{/users/update}" method="post">
            <input type="hidden" name="id" id="edit-user-id">
            <div class="modal-header">
              <h5 class="modal-title"><i class="fas fa-user-edit me-2"></i>Editar Usuario</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label">Nombre *</label>
                  <input type="text" class="form-control" name="nombre" id="edit-user-nombre" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Apellido *</label>
                  <input type="text" class="form-control" name="apellido" id="edit-user-apellido" required>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label">Correo *</label>
                  <input type="email" class="form-control" name="correo" id="edit-user-correo" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Teléfono</label>
                  <input type="tel" class="form-control" name="telefono" id="edit-user-telefono">
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label">Dirección</label>
                  <input type="text" class="form-control" name="direccion" id="edit-user-direccion">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Rol *</label>
                  <select class="form-select" name="rol.id" id="edit-user-rol" required>
                    <option value="" disabled>Selecciona un rol</option>
                    <option th:each="rol : ${roles}" th:value="${rol.id}" th:text="${rol.nombre}"></option>
                  </select>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="form-label">Estado</label>
                  <select class="form-select" name="estado" id="edit-user-estado">
                    <option value="ACTIVO">Activo</option>
                    <option value="INACTIVO">Inactivo</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Contraseña (opcional)</label>
                  <input type="password" class="form-control" name="clave" placeholder="Dejar en blanco si no la cambia">
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-primary"><i class="fas fa-save me-1"></i>Actualizar Usuario</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal Confirmar Eliminación (REUTILIZABLE) -->
    <div class="modal fade" id="confirmDeleteUserModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="fas fa-trash me-2"></i>Eliminar Usuario</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p>¿Seguro que deseas eliminar al usuario <strong id="delete-user-name">NOMBRE</strong>?</p>
            <p class="text-muted">Esta acción no se puede deshacer.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>

            <!-- El enlace final de eliminación (GET) — ajusta la URL si tu backend espera /admin/users/delete/... -->
            <a href="#" id="confirm-delete-link" class="btn btn-danger">
              <i class="fas fa-trash me-1"></i>Eliminar
            </a>
          </div>
        </div>
      </div>
    </div>

  </section>

 
</div>
