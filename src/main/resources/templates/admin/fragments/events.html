<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<section th:fragment="events" class="content-section">
    <div class="container-fluid">

        <!-- Encabezado principal -->
        <div class="section-header mb-4">
            <h2 class="section-title fw-bold">
                <i class="fas fa-calendar me-2"></i>Gestion de Eventos
            </h2>
            <p class="text-muted">Administra los eventos del establecimiento</p>
        </div>

        

		<!-- Subtítulo con botones -->
		<div class="events-header mb-3">
			<div class="d-flex justify-content-between align-items-center mb-2">
				<h4 class="section-subtitle mb-0">
					Lista de Eventos
					<span class="badge bg-primary" th:text="${eventos.size()}"></span>
				</h4>
				<div class="d-flex gap-2">
					<a th:href="@{/cliente}" target="_blank" 
					   class="btn btn-success rounded-pill shadow-sm px-3" title="Ver en Cliente">
						<i class="fas fa-eye me-1"></i> Ver en Cliente
					</a>
					<button class="btn btn-primary rounded-pill shadow-sm px-3" 
					        data-bs-toggle="modal" data-bs-target="#eventModalNew">
						<i class="fas fa-plus me-2"></i> Agregar Evento
					</button>
				</div>
			</div>
			<div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
				<div class="d-flex flex-wrap gap-2 align-items-center" style="flex:1; min-width:260px;">
					<div class="input-group" style="max-width: 320px;">
						<span class="input-group-text"><i class="fas fa-search"></i></span>
						<input type="text" id="eventAdminFilterInput" class="form-control" placeholder="Filtrar eventos...">
					</div>
					<div class="d-flex align-items-center gap-2">
						<label for="eventStatusFilter" class="form-label mb-0">Estado:</label>
						<select id="eventStatusFilter" class="form-select form-select-sm" style="min-width: 150px;">
							<option value="ALL">Todos</option>
							<option value="ACTIVO">Activos</option>
							<option value="INACTIVO">Inactivos</option>
						</select>
					</div>
				</div>
				<div id="eventsPagination" class="btn-group" role="group" aria-label="Paginación"></div>
			</div>
		</div>


        <!-- Tabla -->
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle text-center">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Título</th>
                        <th>Fecha</th>
                        <th>Hora</th>
                        <th>Imagen</th>
                        <th>Estado</th>
                        <th>Activar<br>Desactivar</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="eventsTableBody">
                    <tr th:each="evento : ${eventos}" data-row th:attr="data-status=${evento.estado}">
                        <td th:text="${evento.id}"></td>
                        <td><strong th:text="${evento.titulo}"></strong></td>
                        <td th:text="${#temporals.format(evento.fecha, 'dd/MM/yyyy')}"></td>
                        <td th:text="${evento.hora}"></td>
                        <td>
                            <img th:src="${evento.imagen}" alt="Imagen evento"
                                 class="rounded shadow-sm" style="max-height:60px; max-width:80px;">
                        </td>
                        <td>
                            <span th:class="${evento.estado} == 'ACTIVO' ? 'badge bg-success' : 'badge bg-danger'"
                                  th:text="${evento.estado}"></span>
                        </td>
                        <td>
                            <a th:href="@{/admin/eventos/toggle-estado/{id}(id=${evento.id})}"
                               th:class="${evento.estado} == 'ACTIVO' ? 'btn btn-secondary btn-sm rounded-pill px-3' : 'btn btn-success btn-sm rounded-pill px-3'"
                               th:title="${evento.estado} == 'ACTIVO' ? 'Desactivar' : 'Activar'">
                                <i th:class="${evento.estado} == 'ACTIVO' ? 'fas fa-toggle-off' : 'fas fa-toggle-on'"></i>
                            </a>
                        </td>
                        <td>
                            <div class="d-inline-flex gap-2 justify-content-center">
                                <!-- Editar -->
                                <button class="btn btn-sm btn-warning rounded-4 px-3"
                                        data-bs-toggle="modal"
                                        th:data-bs-target="${'#eventModalEdit' + evento.id}"
                                        title="Editar Evento">
                                    <i class="fas fa-edit"></i>
                                </button>

                                <!-- Eliminar -->
                                <button class="btn btn-sm btn-danger rounded-4 px-3"
                                        data-bs-toggle="modal"
                                        th:data-bs-target="${'#confirmDelete' + evento.id}"
                                        title="Eliminar Evento">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>

                    <tr th:if="${eventos.empty}">
                        <td colspan="6" class="text-center py-4 text-muted">
                            <i class="fas fa-calendar fa-2x mb-3"></i>
                            <p>No hay eventos registrados</p>
                            <button class="btn btn-primary mt-2 rounded-4 px-3 py-2"
                                    data-bs-toggle="modal" data-bs-target="#eventModalNew">
                                <i class="fas fa-plus me-2"></i>Agregar Primer Evento
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal Nuevo -->
    <div class="modal fade" id="eventModalNew" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <form th:action="@{/admin/eventos/guardar}" method="post" enctype="multipart/form-data" class="modal-content rounded-4">
                <div class="modal-header">
                    <h5 class="modal-title text-dark fw-semibold">
                        <i class="fas fa-plus-circle me-2"></i>Nuevo Evento
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Título del Evento</label>
                            <input type="text" class="form-control rounded-4" name="titulo" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Fecha</label>
                            <input type="date" class="form-control rounded-4" name="fecha" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Hora</label>
                            <input type="time" class="form-control rounded-4" name="hora" required>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Imagen del Evento</label>
                            <input type="file" class="form-control rounded-4" name="file" accept="image/*" required>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Descripción</label>
                            <textarea class="form-control rounded-4" name="descripcion" rows="4" maxlength="255" required></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary rounded-4 px-3" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary rounded-4 px-3">
                        <i class="fas fa-save me-2"></i>Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modales Editar / Eliminar -->
    <div th:each="evento : ${eventos}">
        <!-- Editar -->
        <div class="modal fade" th:id="${'eventModalEdit' + evento.id}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <form th:action="@{/admin/eventos/editar/{id}(id=${evento.id})}" method="post" enctype="multipart/form-data" class="modal-content rounded-4">
                    <div class="modal-header">
                        <h5 class="modal-title text-dark fw-semibold"><i class="fas fa-edit me-2"></i>Editar Evento</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Título</label>
                                <input type="text" class="form-control rounded-4" name="titulo" th:value="${evento.titulo}" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Fecha</label>
                                <input type="date" class="form-control rounded-4" name="fecha" th:value="${#temporals.format(evento.fecha, 'yyyy-MM-dd')}" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Hora</label>
                                <input type="time" class="form-control rounded-4" name="hora" th:value="${evento.hora}" required>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Cambiar Imagen</label>
                                <input type="file" class="form-control rounded-4" name="file" accept="image/*">
                                <small class="text-muted">Actual:</small>
                                <div>
                                    <img th:src="${evento.imagen}" class="rounded shadow-sm mt-2" style="max-height:80px; max-width:120px;">
                                </div>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Descripción</label>
                                <textarea class="form-control rounded-4" name="descripcion" rows="4" maxlength="255" th:text="${evento.descripcion}" required></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary rounded-4 px-3" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary rounded-4 px-3"><i class="fas fa-save me-2"></i>Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Confirmar eliminación -->
        <div class="modal fade" th:id="${'confirmDelete' + evento.id}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content rounded-4">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title"><i class="fas fa-trash-alt me-2"></i>Confirmar Eliminación</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <p>¿Estás seguro de eliminar el evento <strong th:text="${evento.titulo}"></strong>?</p>
                        <p class="text-muted small">Esta acción no se puede deshacer.</p>
                    </div>
                    <div class="modal-footer justify-content-center">
                        <button type="button" class="btn btn-secondary rounded-4 px-3" data-bs-dismiss="modal">Cancelar</button>
                        <a th:href="@{/admin/eventos/eliminar/{id}(id=${evento.id})}" class="btn btn-danger rounded-4 px-3">
                            <i class="fas fa-trash me-2"></i>Eliminar
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

	<script>
		(function(){
		  const run = () => {
		    const tbody = document.getElementById('eventsTableBody');
		    const filterInput = document.getElementById('eventAdminFilterInput');
		    const statusSelect = document.getElementById('eventStatusFilter');
		    const pager = document.getElementById('eventsPagination');
		    const pageSize = 4;
		    let rows = Array.from(tbody ? tbody.querySelectorAll('tr[data-row]') : []);
		    let emptyRow = tbody ? tbody.querySelector('tr:not([data-row])') : null;
		    let filtered = rows.slice();
		    let page = 1;

		    function getText(r){
		      const tds = r.querySelectorAll('td');
		      const id = tds[0] ? (tds[0].innerText || '') : '';
		      const title = tds[1] ? (tds[1].innerText || '') : '';
		      const date = tds[2] ? (tds[2].innerText || '') : '';
		      const time = tds[3] ? (tds[3].innerText || '') : '';
		      return (id + ' ' + title + ' ' + date + ' ' + time).toLowerCase();
		    }

		    function render(){
		      rows.forEach(r => r.style.display = 'none');
		      if (emptyRow) emptyRow.style.display = filtered.length ? 'none' : '';
		      const total = filtered.length;
		      const pages = Math.max(1, Math.ceil(total / pageSize));
		      page = Math.min(page, pages);
		      const start = (page - 1) * pageSize;
		      const end = start + pageSize;
		      filtered.slice(start, end).forEach(r => r.style.display = '');
		      renderPager(pages, total);
		    }

            function renderPager(pages, total){
              if (!pager) return;
              pager.innerHTML = '';
              if (total <= pageSize) return;

              const maxButtons = 3;
              const makeBtn = (label, active, disabled, click) => {
                const b = document.createElement('button');
                b.type = 'button';
                b.className = 'btn ' + (active ? 'btn-primary' : 'btn-outline-secondary');
                b.textContent = label;
                b.disabled = !!disabled;
                if (click) b.onclick = click;
                return b;
              };

              pager.appendChild(makeBtn('«', false, page <= 1, () => { page = Math.max(1, page - 1); render(); }));

              if (pages <= maxButtons) {
                for (let i = 1; i <= pages; i++) pager.appendChild(makeBtn(String(i), i === page, false, () => { page = i; render(); }));
              } else {
                let start = Math.max(1, page - Math.floor((maxButtons - 1) / 2));
                let end = Math.min(pages, start + maxButtons - 1);
                if (end - start + 1 < maxButtons) start = Math.max(1, end - maxButtons + 1);
                if (start > 1) {
                  pager.appendChild(makeBtn('1', false, false, () => { page = 1; render(); }));
                  pager.appendChild(makeBtn('…', false, true));
                }
                for (let i = start; i <= end; i++) pager.appendChild(makeBtn(String(i), i === page, false, () => { page = i; render(); }));
                if (end < pages) {
                  pager.appendChild(makeBtn('…', false, true));
                  pager.appendChild(makeBtn(String(pages), false, false, () => { page = pages; render(); }));
                }
              }

              pager.appendChild(makeBtn('»', false, page >= pages, () => { page = Math.min(pages, page + 1); render(); }));
            }

		    function applyFilter(){
		      const q = (filterInput?.value || '').toLowerCase().trim();
		      const status = (statusSelect?.value || 'ALL');
		      filtered = rows.filter(r => {
		        const textMatch = !q || getText(r).includes(q);
		        const rowStatus = r.getAttribute('data-status') || '';
		        const statusMatch = status === 'ALL' || rowStatus === status;
		        return textMatch && statusMatch;
		      });
		      page = 1; render();
		    }

		    if (filterInput) filterInput.addEventListener('input', applyFilter);
		    if (statusSelect) statusSelect.addEventListener('change', applyFilter);
		    render();
		  };
		  if (document.readyState === 'loading') {
		    document.addEventListener('DOMContentLoaded', run);
		  } else {
		    run();
		  }
		})();
	</script>

</section>

</body>
</html>
