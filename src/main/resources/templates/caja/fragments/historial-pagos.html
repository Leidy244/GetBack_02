<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<div th:fragment="historial-pagos">
    <div class="section-header mb-4">
        <h2 class="section-title text-dark-emphasis">
            <i class="fas fa-receipt me-2 title-icon"></i>Historial de Pagos
            <span class="badge bg-primary ms-1" th:text="${pagosPagados != null ? #lists.size(pagosPagados) : 0}">0</span>
        </h2>
        <p class="text-muted mb-0">
            <span>Mostrando: </span>
            <span th:switch="${filtro}">
                <span th:case="'hoy'">Hoy</span>
                <span th:case="'semana'">Última semana (lunes a domingo)</span>
                <span th:case="'mes'">Este mes</span>
                <span th:case="'anio'">Este año</span>
                <span th:case="*">Todo el historial</span>
            </span>
        </p>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
        <div class="d-flex align-items-center gap-2">
            <div class="input-group" style="max-width: 320px;">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" id="historialBusqueda" class="form-control" placeholder="Filtrar historial...">
            </div>
            <form th:action="@{/caja}" method="get" class="d-flex align-items-center gap-2">
                <input type="hidden" name="section" value="historial-pagos"/>
                <label for="historial-filtro" class="form-label mb-0">Ver:</label>
                <select id="historial-filtro" name="filtro" class="form-select form-select-sm" style="width: auto;">
                    <option value="" th:selected="${filtro == null or #strings.isEmpty(filtro)}">Todo</option>
                    <option th:value="hoy" th:selected="${filtro == 'hoy'}">Hoy</option>
                    <option th:value="semana" th:selected="${filtro == 'semana'}">Última semana</option>
                    <option th:value="mes" th:selected="${filtro == 'mes'}">Este mes</option>
                    <option th:value="anio" th:selected="${filtro == 'anio'}">Este año</option>
                </select>
            </form>
            <div class="d-flex align-items-center gap-2">
                <label for="historial-orden" class="form-label mb-0">Orden:</label>
                <select id="historial-orden" class="form-select form-select-sm" style="width: auto;">
                    <option value="reciente" selected>Más reciente</option>
                    <option value="viejo">Más viejo</option>
                </select>
            </div>
        </div>
        <div id="historialPagination" class="btn-group" role="group" aria-label="Paginación"></div>
    </div>

    <div class="table-container table-scroll">
        <table class="table table-striped" id="tabla-historial-pagos">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Mesa</th>
                    <th>Detalle</th>
                    <th>Total</th>
                    <th>Estado pago</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="pago, iStat : ${pagosPagados}"
                    data-row="hist"
                    th:attr="data-fecha=${pago.fechaCreacion}">
                    <td th:text="${iStat.index + 1}">1</td>
                    <td>
                        <strong th:text="${pago.mesa != null ? 'Mesa ' + pago.mesa.numero : 'Sin mesa'}">Mesa 1</strong>
                        <br>
                        <small th:text="${#temporals.format(pago.fechaCreacion, 'dd/MM/yyyy HH:mm')}">12/11/2025 18:30</small>
                    </td>
                    <td>
                        <button type="button" class="btn btn-link p-0 text-start ver-detalle-pago"
                                th:attr="data-origen='historial',
                                         data-pedido-id=${pago.id},
                                         data-mesa=${pago.mesa != null ? pago.mesa.numero : 'Sin mesa'},
                                         data-total=${pago.total},
                                         data-recibido=${pago.montoRecibido},
                                         data-cambio=${pago.cambio},
                                         data-detalle=${pago.orden}">
                            <span class="d-inline-block text-truncate detalle-resumen-text" style="max-width: 360px;">
                                Ver detalle del pedido
                            </span>
                        </button>
                    </td>
                    <td th:text="${#strings.concat('$', #numbers.formatDecimal(pago.total, 0, 'POINT', 0, 'POINT'))}">$0</td>
                    <td>
                        <span class="badge bg-success"
                              th:text="${pago.estado != null ? pago.estado.nombreEstado : 'PAGADO'}">PAGADO</span>
                    </td>
                </tr>

                <tr th:if="${pagosPagados == null or #lists.isEmpty(pagosPagados)}">
                    <td colspan="5" class="text-center py-4">
                        <i class="fas fa-receipt" style="font-size:2rem; color: var(--text-secondary);"></i>
                        <p class="mt-2 mb-0">Aún no hay historial de pagos.</p>
                        <small class="text-muted">Cuando cobres un pedido aparecerá en este listado.</small>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="d-flex justify-content-start align-items-center mt-2">
        <div id="historialInfo" class="text-muted small"></div>
    </div>
</div>
</body>
</html>
