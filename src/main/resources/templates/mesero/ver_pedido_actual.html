<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Resumen de Pedido | GETBACK</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="stylesheet" th:href="@{/css/ver_pedido_actual.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	
</head>
<body>
    <div class="container">
        <header class="header">
            <h1><img th:src="@{/images/Logo_principal.png}" width="100" alt="Logo Get Back"> Resumen del Pedido</h1>
            <div class="mesa-info">
                <span class="mesa-numero">Mesa #<span th:text="${mesa != null and mesa.numero != null} ? ${mesa.numero} : ${mesaId}">0</span></span>
                <span class="mesa-personas" th:if="${mesa != null and mesa.capacidad != null}" th:text="${mesa.capacidad} + ' personas'">0 personas</span>
                <span class="mesa-ubicacion" th:if="${mesa != null and mesa.ubicacion != null}" th:text="${mesa.ubicacion.nombre}">Ubicación</span>
                <span class="estado-pedido"
                      th:text="${pedido != null ? (pedido.estado != null ? pedido.estado.nombreEstado : pedido.estadoPago) : 'PENDIENTE'}">PENDIENTE</span>
            </div>
        </header>

        <main class="main-content">
            <section class="pedido-actual">
                <div class="pedido-header">
                    <h2>Detalle del Pedido</h2>
                    <span class="fecha-pedido">
                        <i class="fas fa-calendar"></i>
                        <span id="fechaHoraPedido"></span>
                    </span>
                </div>

                <div th:if="${error}" class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span th:text="${error}"></span>
                    <a th:href="@{/mesero/menu(mesa=${mesaId})}" class="btn-crear-pedido">
                        <i class="fas fa-plus"></i> Crear Nuevo Pedido
                    </a>
                </div>

                <div th:unless="${error}" class="items-list">
                    <div th:if="${itemsMap != null and itemsMap['items'] != null and !#lists.isEmpty(itemsMap['items'])}">
                        <div th:each="item : ${itemsMap['items']}" class="item">
                            <div class="item-info">
                                <span class="item-cantidad" th:text="${item.cantidad} + 'x'">1x</span>
                                <span class="item-nombre" th:text="${item.productoNombre}">Producto</span>
                                <span class="item-precio"
                                      th:text="${#strings.concat('$', #numbers.formatDecimal(item.subtotal, 0, 'POINT', 0, 'POINT'))}">$0</span>

                            </div>
                            <div th:if="${item.comentarios != null and !item.comentarios.isEmpty()}" 
                                 class="item-notas" th:text="${item.comentarios}">Notas</div>
                            <div class="item-precio-unitario"
                                 th:text="${#strings.concat('$', #numbers.formatDecimal(item.precio, 0, 'POINT', 0, 'POINT'), ' c/u')}">$0 c/u</div>

                        </div>
                    </div>

                    <!-- Los comentarios ahora están integrados en el campo comentario junto con los items -->
                    <div th:if="${pedido == null and draftComentarios != null and !#strings.isEmpty(draftComentarios)}" 
                         class="comentarios-generales">
                        <strong><i class="fas fa-sticky-note"></i> Comentarios: </strong>
                        <span th:text="${draftComentarios}"></span>
                    </div>

                    <div th:if="${itemsMap == null or itemsMap['items'] == null or #lists.isEmpty(itemsMap['items'])}" class="no-items">
                        <i class="fas fa-shopping-cart"></i>
                        <p>No hay items en este pedido</p>
                    </div>
                </div>

                <div th:if="${(hasDraft == true and draftTotal != null) or (pedido != null and pedido.total != null)}" class="pedido-totales">
                    <div class="total-line total-final">
                        <span>TOTAL:</span>
                        <span th:text="${#strings.concat('$', (hasDraft == true and draftTotal != null)
                                ? #numbers.formatDecimal(draftTotal, 0, 'POINT', 0, 'POINT')
                                : #numbers.formatDecimal(pedido.total, 0, 'POINT', 0, 'POINT'))}">$0</span>

                    </div>
                </div>
            </section>
        </main>

        <footer class="footer">
            <button class="btn btn-cancelar" onclick="cancelarPedido()">
                <i class="fas fa-times"></i> Cancelar Pedido
            </button>
            <form method="post" th:action="@{/pedidos/editar}" style="display:inline-block;">
                <input type="hidden" name="mesaId" th:value="${mesaId}" />
                <button class="btn btn-editar" type="submit">
                    <i class="fas fa-edit"></i> Editar
                </button>
            </form>
            <form method="post" th:action="@{/pedidos/confirmar}">
                <input type="hidden" name="mesaId"
                       th:value="${mesaId}" />
                <input type="hidden" name="itemsJson"
                       th:value="${draftItemsJson != null ? draftItemsJson : (pedido != null ? pedido.orden : '')}" />
                <input type="hidden" name="comentarios"
                       th:value="${draftComentarios != null ? draftComentarios : (pedido != null ? pedido.comentariosGenerales : '')}" />
                <input type="hidden" name="total"
                       th:value="${draftTotal != null ? draftTotal : (pedido != null ? pedido.total : 0)}" />
                <button class="btn btn-confirmar" type="submit">
                    <i class="fas fa-paper-plane"></i> Confirmar Pedido
                </button>
            </form>
        </footer>
    </div>

    <script th:src="@{/js/ConfigMesero.js}" defer></script>
    <script>
        // Efecto adicional: hacer el overlay ligeramente interactivo


        function volverAlMenu() {
            window.history.back();
        }

        function cancelarPedido() {
            const ejecutar = () => { window.location.href = '/pedidos/cancelar'; };
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'question',
                    title: '¿Seguro desea cancelar este pedido?',
                    text: 'Se eliminará el borrador y volverás al menú.',
                    showCancelButton: true,
                    confirmButtonText: 'Cancelar pedido',
                    cancelButtonText: 'Volver',
                    confirmButtonColor: '#7b2ff7',
                    cancelButtonColor: '#6c757d'
                }).then(r => { if (r.isConfirmed) { try { mostrarToast('Cancelando pedido...'); } catch(_){} ejecutar(); } });
            } else {
                if (confirm('¿Seguro desea cancelar este pedido?')) ejecutar();
            }
        }

        // La acción de editar ahora se maneja vía POST /pedidos/editar en el backend

        document.addEventListener('DOMContentLoaded', function() {
            const fechaSpan = document.getElementById('fechaHoraPedido');
            if (fechaSpan) {
                const ahora = new Date();
                const opciones = { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' };
                fechaSpan.textContent = ahora.toLocaleString('es-CO', opciones);
            }

        });
    </script>
</body>
</html>
