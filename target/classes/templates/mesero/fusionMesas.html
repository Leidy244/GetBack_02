<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mesas - GETBACK Mesero</title>
  <link rel="icon" type="image/png" th:href="@{/images/Logo_Ignitia.png}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" th:href="@{/css/fusionMesas.css}">
</head>
<body>

<!-- Toast de Bienvenida -->
<div class="welcome-toast" id="welcome-toast">
  <div class="toast-content">
    <div class="toast-icon"><i class="fas fa-utensils"></i></div>
    <div class="toast-text">
      <h2>¡Bienvenido!</h2>
      <p class="toast-subtitle">Selecciona una mesa para empezar</p>
    </div>
  </div>
  <button class="close-toast" aria-label="Cerrar mensaje">
    <i class="fas fa-times"></i>
  </button>
  <div class="toast-progress"></div>
</div>

<!-- Header -->
<header>
  <div class="container">
    <nav>
      <div class="logo">
        <a th:href="@{/configuracion}">
          <img th:src="@{~/images/Logo_principal.png}" width="100" alt="Logo Get Back">
        </a>
        <span>Panel de Mesas</span>
      </div>
      <div class="nav-controls">
        <button class="menu-toggle" id="menu-toggle" aria-label="Menú">
          <i class="fas fa-bars"></i>
        </button>
        <div class="user-dropdown" sec:authorize="hasAuthority('ADMIN')">
          <button class="user-profile" id="userDropdown" type="button" onclick="toggleUserMenu(event)">
            <i class="fas fa-user-circle"></i>
            <span>Mesero</span>
            <i class="dropdown-arrow fas fa-chevron-down"></i>
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" th:href="@{/admin}"><i class="fas fa-cog"></i> Administrador</a></li>
            <li><a class="dropdown-item" th:href="@{/caja}"><i class="fas fa-cash-register"></i> Panel Cajero</a></li>
            <li class="dropdown-divider"></li>
            <li>
              <button class="logout-btn"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</button>
            </li>
          </ul>
        </div>
      </div>
      <ul class="nav-links" id="nav-links">
        <li><a href="#" class="filter-btn-zone active" data-zone="todas"><i class="fas fa-layer-group"></i> Todas las Áreas</a></li>
        <li th:each="ubicacion : ${ubicaciones}">
          <a href="#" class="filter-btn-zone" th:data-zone="${ubicacion.nombre}" th:text="${ubicacion.nombre}">Categoría</a>
        </li>
      </ul>
    </nav>
  </div>
</header>

<main class="container">
  <!-- Panel de Control -->
  <div class="control-panel">
    <div class="filter-buttons-container">
      <button class="filter-btn-status active" data-filter="todas"><i class="fas fa-border-all"></i> Todas las Mesas</button>
      <button class="filter-btn-status" data-filter="disponible"><i class="fas fa-check-circle"></i> Disponibles</button>
      <button class="filter-btn-status" data-filter="ocupada"><i class="fas fa-times-circle"></i> Ocupadas</button>
    </div>

    <div class="stats-container">
      <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-chair"></i></div>
        <div class="stat-content">
          <div class="stat-number" th:text="${totalMesas}">0</div>
          <div class="stat-label">Total Mesas</div>
        </div>
      </div>
      <div class="stat-card available">
        <div class="stat-icon"><i class="fas fa-check"></i></div>
        <div class="stat-content">
          <div class="stat-number" th:text="${mesasDisponibles}">0</div>
          <div class="stat-label">Disponibles</div>
        </div>
      </div>
      <div class="stat-card occupied">
        <div class="stat-icon"><i class="fas fa-users"></i></div>
        <div class="stat-content">
          <div class="stat-number" th:text="${mesasOcupadas}">0</div>
          <div class="stat-label">Ocupadas</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Contenedor de Ubicaciones -->
  <div class="ubicaciones-container" id="ubicaciones-container">
    <!-- Sección Todas las Mesas -->
    <div class="ubicacion-section todas-las-mesas" data-ubicacion="todas">
      <div class="ubicacion-header">
        <div class="ubicacion-title"><i class="fas fa-layer-group"></i><span>Todas las Mesas del Establecimiento</span></div>
        <div class="ubicacion-stats">
          <span class="ubicacion-stat disponible"><i class="fas fa-check"></i><span th:text="${mesasDisponibles} + ' disp.'"></span></span>
          <span class="ubicacion-stat ocupada"><i class="fas fa-users"></i><span th:text="${mesasOcupadas} + ' ocp.'"></span></span>
        </div>
      </div>
      <div class="mesas-grid">
        <div th:each="mesa : ${mesas}" class="mesa-card"
             th:data-ubicacion="${mesa.ubicacion?.nombre ?: 'general'}"
             th:data-estado="${mesa.estado?.toLowerCase()}"
             th:onclick="|redirectMesa(${mesa.id}, this)|"
             th:classappend="${mesa.estado == 'OCUPADA'} ? 'mesa-ocupada' : 'mesa-disponible'">
          <div class="mesa-header">
            <div class="mesa-numero" th:text="${'Mesa ' + mesa.numero}">Mesa #</div>
            <div class="mesa-indicador" th:classappend="${mesa.estado == 'DISPONIBLE'} ? 'indicador-disponible' : 'indicador-ocupada'"></div>
          </div>
          <div class="mesa-content">
            <div class="mesa-info">
              <div class="mesa-capacidad"><i class="fas fa-user-friends"></i><span th:text="${mesa.capacidad} + ' personas'"></span></div>
              <div class="mesa-ubicacion"><i class="fas fa-map-marker-alt"></i><span th:text="${mesa.ubicacion?.nombre ?: 'Área General'}"></span></div>
            </div>
            <div class="mesa-estado" th:classappend="${mesa.estado == 'DISPONIBLE'} ? 'estado-disponible' : 'estado-ocupada'">
              <i th:if="${mesa.estado == 'DISPONIBLE'}" class="fas fa-check"></i>
              <i th:if="${mesa.estado == 'OCUPADA'}" class="fas fa-users"></i>
              <span th:text="${mesa.estado}">DISPONIBLE</span>
            </div>
          </div>
          <div class="mesa-info-adicional" th:if="${mesa.descripcion}">
            <i class="fas fa-info-circle"></i><span th:text="${mesa.descripcion}"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Secciones por Ubicación -->
    <div th:each="ubicacion : ${ubicaciones}" class="ubicacion-section" th:data-ubicacion="${ubicacion.nombre}">
      <div class="ubicacion-header">
        <div class="ubicacion-title"><i class="fas fa-map-marker-alt"></i><span th:text="${ubicacion.nombre}"></span></div>
        <div class="ubicacion-stats">
          <span class="ubicacion-stat disponible">
            <i class="fas fa-check"></i>
            <span th:with="disp=${#lists.size(mesas.?[ubicacion?.id == ubicacion.id and estado == 'DISPONIBLE'])}" th:text="${disp} + ' disp.'"></span>
          </span>
          <span class="ubicacion-stat ocupada">
            <i class="fas fa-users"></i>
            <span th:with="ocp=${#lists.size(mesas.?[ubicacion?.id == ubicacion.id and estado == 'OCUPADA'])}" th:text="${ocp} + ' ocp.'"></span>
          </span>
        </div>
      </div>
      <div class="mesas-grid">
        <div th:each="mesa : ${mesas}" th:if="${mesa.ubicacion?.id == ubicacion.id}" class="mesa-card"
             th:data-ubicacion="${ubicacion.nombre}"
             th:data-estado="${mesa.estado?.toLowerCase()}"
             th:onclick="|redirectMesa(${mesa.id}, this)|"
             th:classappend="${mesa.estado == 'OCUPADA'} ? 'mesa-ocupada' : 'mesa-disponible'">
          <div class="mesa-header">
            <div class="mesa-numero" th:text="${'Mesa ' + mesa.numero}"></div>
            <div class="mesa-indicador" th:classappend="${mesa.estado == 'DISPONIBLE'} ? 'indicador-disponible' : 'indicador-ocupada'"></div>
          </div>
          <div class="mesa-content">
            <div class="mesa-info">
              <div class="mesa-capacidad"><i class="fas fa-user-friends"></i><span th:text="${mesa.capacidad} + ' personas'"></span></div>
              <div class="mesa-ubicacion"><i class="fas fa-map-marker-alt"></i><span th:text="${ubicacion.nombre}"></span></div>
            </div>
            <div class="mesa-estado" th:classappend="${mesa.estado == 'DISPONIBLE'} ? 'estado-disponible' : 'estado-ocupada'">
              <i th:if="${mesa.estado == 'DISPONIBLE'}" class="fas fa-check"></i>
              <i th:if="${mesa.estado == 'OCUPADA'}" class="fas fa-users"></i>
              <span th:text="${mesa.estado}"></span>
            </div>
          </div>
          <div class="mesa-info-adicional" th:if="${mesa.descripcion}">
            <i class="fas fa-info-circle"></i><span th:text="${mesa.descripcion}"></span>
          </div>
        </div>

        <!-- Mensaje si no hay mesas en esta ubicación -->
        <div th:if="${#lists.size(mesas.?[ubicacion?.id == ubicacion.id]) == 0}" class="no-mesas-message">
          <i class="fas fa-chair"></i>
          <h3>No hay mesas en esta ubicación</h3>
          <p>Esta área no tiene mesas asignadas</p>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Modal Pedido Mesa Ocupada -->
<div id="modal-pedido-mesa" class="modal-pedido" style="display:none;">
  <div class="modal-pedido-content">
    <div class="modal-pedido-header">
      <h2 id="modal-mesa-titulo">Mesa</h2>
      <button type="button" id="modal-pedido-close" class="modal-pedido-close"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-pedido-body">
      <div id="modal-pedido-resumen" class="modal-pedido-resumen">
        <!-- Se llena por JS -->
      </div>
    </div>
    <div class="modal-pedido-footer">
      <form id="form-editar-pedido" th:action="@{/pedidos/editar}" method="post">
        <input type="hidden" name="mesaId" id="modal-mesa-id" />
        <button type="submit" class="btn-agregar-productos">
          <i class="fas fa-plus"></i> Agregar productos al pedido
        </button>
      </form>
    </div>
  </div>
</div>

<button id="back-to-top" title="Volver arriba"><i class="fas fa-chevron-up"></i></button>

<script>
  function toggleUserMenu(e) {
    e.preventDefault();
    e.stopPropagation();
    const btn = e.currentTarget;
    const wrapper = btn.closest('.user-dropdown');
    if (!wrapper) return;
    const menu = wrapper.querySelector('.dropdown-menu');
    if (!menu) return;
    menu.classList.toggle('show');
    btn.classList.toggle('active');

    // Cerrar al hacer clic fuera
    document.addEventListener('click', function handleClickOutside(ev) {
      if (!wrapper.contains(ev.target)) {
        menu.classList.remove('show');
        btn.classList.remove('active');
        document.removeEventListener('click', handleClickOutside);
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function () {

    try {
      const saved = JSON.parse(localStorage.getItem('meseroSettings')) || {};
      const theme = saved.theme || 'default';

      if (theme && theme !== 'default') {
        document.documentElement.setAttribute('data-color', theme);
      } else {
        document.documentElement.removeAttribute('data-color');
      }
    } catch (e) {
      console.warn('No se pudo aplicar el tema del mesero en Fusion Mesas', e);
    }

    initFilters();

    const logoutBtn = document.querySelector('.logout-btn');

    if (logoutBtn) {
      logoutBtn.addEventListener('click', function () {
        if (confirm('¿Seguro que deseas cerrar sesión?')) {
          window.location.href = '/login';

          // Si usas Spring Security con /logout, cambia la línea anterior a:
          // window.location.href = '/logout';
        }
      });
    }
  });

  function redirectMesa(mesaId, element) {
    const estado = element.getAttribute('data-estado');
    const numeroMesa = element.querySelector('.mesa-numero')?.textContent || 'Mesa';

    if (estado === 'disponible') {
      sessionStorage.setItem('mesaId', mesaId);   // ← NUEVO
      element.style.pointerEvents = 'none';
      element.style.opacity = '0.7';
      element.style.transform = 'scale(0.95)';
      showNotification(`Redirigiendo a ${numeroMesa}...`, 'info');
      setTimeout(() => {
        window.location.href = `/mesero/menu?mesa=${mesaId}`;
      }, 800);
    } else {
      abrirModalPedidoMesa(mesaId, numeroMesa, element);
    }
  }

  function abrirModalPedidoMesa(mesaId, numeroMesa, element) {
    const modal = document.getElementById('modal-pedido-mesa');
    const titulo = document.getElementById('modal-mesa-titulo');
    const resumenDiv = document.getElementById('modal-pedido-resumen');
    const mesaIdInput = document.getElementById('modal-mesa-id');
    const btnClose = document.getElementById('modal-pedido-close');

    if (!modal || !resumenDiv || !mesaIdInput) {
      showNotification(`${numeroMesa} está ocupada, pero no se pudo abrir el detalle.`, 'error');
      return;
    }

    titulo.textContent = numeroMesa;
    mesaIdInput.value = mesaId;
    resumenDiv.innerHTML = '<p>Cargando información del pedido...</p>';

    modal.style.display = 'flex';

    if (btnClose) {
      btnClose.onclick = () => {
        modal.style.display = 'none';
      };
    }

    modal.onclick = (e) => {
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    };

    fetch(`/mesero/pedido/resumen?mesaId=${mesaId}`)
      .then(r => r.json())
      .then(data => {
        if (!data.success) {
          resumenDiv.innerHTML = `<p>No se pudo cargar el pedido: ${data.message || ''}</p>`;
          return;
        }

        if (data.tienePedidoActivo) {
          const fecha = data.fechaCreacion ? new Date(data.fechaCreacion).toLocaleString() : '';

          let itemsHtml = '';
          if (data.ordenJson) {
            try {
              const raw = JSON.parse(data.ordenJson);
              const items = raw.items || raw; // por si se guarda directo el array
              if (Array.isArray(items)) {
                itemsHtml = items.map(it => {
                  const nombre = it.productoNombre || it.name || 'Producto';
                  const cant = it.cantidad || it.quantity || 1;
                  const precio = it.precio || it.price || 0;
                  const subtotal = it.subtotal || (precio * cant) || 0;
                  return `<li>
                    <span class="prod-nombre">${nombre}</span>
                    <span class="prod-cant">x${cant}</span>
                    <span class="prod-subtotal">$${subtotal.toFixed(2)}</span>
                  </li>`;
                }).join('');
              }
            } catch (e) {
              console.error('Error parseando ordenJson', e);
            }
          }

          let productosSection = '';
          if (itemsHtml) {
            productosSection = `
              <h4>Productos</h4>
              <ul class="lista-productos-pedido">${itemsHtml}</ul>
            `;
          }

          resumenDiv.innerHTML = `
            <div class="pedido-activo-resumen">
              <h3>Pedido activo</h3>
              <p><strong>ID:</strong> ${data.pedidoActivoId}</p>
              <p><strong>Total:</strong> $${data.total != null ? data.total.toFixed(2) : '0.00'}</p>
              <p><strong>Creado:</strong> ${fecha}</p>
              ${productosSection}
            </div>
          `;
        } else {
          resumenDiv.innerHTML = '<p>No hay pedido activo para esta mesa.</p>';
        }
      })
      .catch(err => {
        console.error(err);
        resumenDiv.innerHTML = '<p>Error al cargar la información del pedido.</p>';
      });
  }

  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
      <div class="notification-content">
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
        <span>${message}</span>
      </div>
    `;
    document.body.appendChild(notification);
    setTimeout(() => notification.classList.add('show'), 100);
    setTimeout(() => {
      notification.classList.remove('show');
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }

  function initFilters() {
    const filterZoneButtons = document.querySelectorAll('.filter-btn-zone');
    const filterStatusButtons = document.querySelectorAll('.filter-btn-status');

    filterZoneButtons.forEach(btn => {
      btn.addEventListener('click', function (e) {
        e.preventDefault();
        filterZoneButtons.forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        const zona = this.getAttribute('data-zone');
        filterByZone(zona);
      });
    });

    filterStatusButtons.forEach(btn => {
      btn.addEventListener('click', function () {
        filterStatusButtons.forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        const estado = this.getAttribute('data-filter');
        filterByStatus(estado);
      });
    });
  }

  function filterByZone(zona) {
    const ubicaciones = document.querySelectorAll('.ubicacion-section');
    ubicaciones.forEach(ubicacion => {
      ubicacion.style.display = (zona === 'todas' || ubicacion.getAttribute('data-ubicacion') === zona) ? 'block' : 'none';
    });
    const estadoActivo = document.querySelector('.filter-btn-status.active');
    if (estadoActivo) {
      filterByStatus(estadoActivo.getAttribute('data-filter'));
    }
  }

  function filterByStatus(estado) {
    const mesas = document.querySelectorAll('.mesa-card');
    mesas.forEach(mesa => {
      const mesaEstado = mesa.getAttribute('data-estado');
      const parentSection = mesa.closest('.ubicacion-section');
      const isParentVisible = parentSection.style.display !== 'none';
      mesa.style.display = (estado === 'todas' || mesaEstado === estado) && isParentVisible ? 'flex' : 'none';
    });
  }

  document.addEventListener('DOMContentLoaded', function () {
    const toast = document.getElementById('welcome-toast');
    const closeBtn = document.querySelector('.close-toast');

    if (toast) {
      const alreadyShown = sessionStorage.getItem('welcomeToastShown') === 'true';

      if (alreadyShown) {
        toast.style.display = 'none';
      } else {
        toast.style.display = 'flex';
        setTimeout(() => toast.classList.add('show'), 500);

        if (closeBtn) {
          closeBtn.addEventListener('click', () => {
            sessionStorage.setItem('welcomeToastShown', 'true');
            toast.classList.remove('show');
            setTimeout(() => toast.style.display = 'none', 500);
          });
        }

        setTimeout(() => {
          if (toast.classList.contains('show')) {
            sessionStorage.setItem('welcomeToastShown', 'true');
            toast.classList.remove('show');
            setTimeout(() => toast.style.display = 'none', 500);
          }
        }, 5000);
      }
    }

    initFilters();

    // Dropdown de usuario (Mesero / Admin / Caja / Cerrar sesión)
    const userDropdownBtn = document.getElementById('userDropdown');
    const dropdownMenu = document.querySelector('.user-dropdown .dropdown-menu');
    const logoutBtn = document.querySelector('.logout-btn');

    if (userDropdownBtn && dropdownMenu) {
      userDropdownBtn.addEventListener('click', function (e) {
        e.preventDefault();
        e.stopPropagation();
        dropdownMenu.classList.toggle('show');
        userDropdownBtn.classList.toggle('active');
      });

      document.addEventListener('click', function (e) {
        if (!dropdownMenu.contains(e.target) && !userDropdownBtn.contains(e.target)) {
          dropdownMenu.classList.remove('show');
          userDropdownBtn.classList.remove('active');
        }
      });

      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
          dropdownMenu.classList.remove('show');
          userDropdownBtn.classList.remove('active');
        }
      });
    }

    if (logoutBtn) {
      logoutBtn.addEventListener('click', function () {
        if (confirm('¿Seguro que deseas cerrar sesión?')) {
          window.location.href = '/login';
          // Si usas Spring Security con /logout, cambia la línea anterior a:
          // window.location.href = '/logout';
        }
      });
    }
  });

  // (Bloque DOMContentLoaded principal se definió más arriba y maneja
  // tema, filtros, dropdown y logout. Aquí ya no es necesario duplicarlo.)

</script>

<script th:src="@{/js/fusionMesas.js}" defer></script>
</body>
</html>