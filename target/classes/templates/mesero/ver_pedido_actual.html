<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Resumen de Pedido | GETBACK</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="stylesheet" th:href="@{/css/ver_pedido_actual.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1><img th:src="@{/imgs/logo-get-back-cafe-bar.png}" width="100" alt="Logo Get Back"> Resumen del Pedido</h1>
            <div class="mesa-info">
                <span class="mesa-numero">Mesa #<span th:text="${mesa != null and mesa.numero != null} ? ${mesa.numero} : ${mesaId}">0</span></span>
                <span class="mesa-personas" th:if="${mesa != null and mesa.capacidad != null}" th:text="${mesa.capacidad} + ' personas'">0 personas</span>
                <span class="mesa-ubicacion" th:if="${mesa != null and mesa.ubicacion != null}" th:text="${mesa.ubicacion.nombre}">Ubicación</span>
                <span class="estado-pedido"
                      th:text="${pedido != null ? (pedido.estado != null ? pedido.estado.nombreEstado : pedido.estadoPago) : 'PENDIENTE'}">PENDIENTE</span>
            </div>
        </header>

        <main class="main-content">
            <section class="pedido-actual">
                <div class="pedido-header">
                    <h2>Detalle del Pedido</h2>
                    <span class="fecha-pedido">
                        <i class="fas fa-calendar"></i>
                        <span id="fechaHoraPedido"></span>
                    </span>
                </div>

                <div th:if="${error}" class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span th:text="${error}"></span>
                    <a th:href="@{/mesero/menu(mesa=${mesaId})}" class="btn-crear-pedido">
                        <i class="fas fa-plus"></i> Crear Nuevo Pedido
                    </a>
                </div>

                <div th:unless="${error}" class="items-list">
                    <div th:if="${itemsMap != null and itemsMap['items'] != null and !#lists.isEmpty(itemsMap['items'])}">
                        <div th:each="item : ${itemsMap['items']}" class="item">
                            <div class="item-info">
                                <span class="item-cantidad" th:text="${item.cantidad} + 'x'">1x</span>
                                <span class="item-nombre" th:text="${item.productoNombre}">Producto</span>
                                <span class="item-precio" th:text="'$' + ${#numbers.formatDecimal(item.subtotal, 1, 2, 'COMMA')}">$0.00</span>
                            </div>
                            <div th:if="${item.comentarios != null and !item.comentarios.isEmpty()}" 
                                 class="item-notas" th:text="${item.comentarios}">Notas</div>
                            <div class="item-precio-unitario" th:text="'$' + ${#numbers.formatDecimal(item.precio, 1, 2, 'COMMA')} + ' c/u'">$0.00 c/u</div>
                        </div>
                    </div>

                    <!-- Los comentarios ahora están integrados en el campo comentario junto con los items -->
                    <div th:if="${pedido == null and draftComentarios != null and !#strings.isEmpty(draftComentarios)}" 
                         class="comentarios-generales">
                        <strong><i class="fas fa-sticky-note"></i> Comentarios: </strong>
                        <span th:text="${draftComentarios}"></span>
                    </div>

                    <div th:if="${itemsMap == null or itemsMap['items'] == null or #lists.isEmpty(itemsMap['items'])}" class="no-items">
                        <i class="fas fa-shopping-cart"></i>
                        <p>No hay items en este pedido</p>
                    </div>
                </div>

                <div th:if="${(hasDraft == true and draftTotal != null) or (pedido != null and pedido.total != null)}" class="pedido-totales">
                    <div class="total-line total-final">
                        <span>TOTAL:</span>
                        <span th:text="'$' + ${(hasDraft == true and draftTotal != null)
                                ? #numbers.formatDecimal(draftTotal, 1, 2, 'COMMA')
                                : #numbers.formatDecimal(pedido.total, 1, 2, 'COMMA')}">$0.00</span>
                    </div>
                </div>
            </section>
        </main>

        <footer class="footer">
            <button class="btn btn-cancelar" onclick="cancelarPedido()">
                <i class="fas fa-times"></i> Cancelar Pedido
            </button>
            <button class="btn btn-editar" onclick="editarPedido()">
                <i class="fas fa-edit"></i> Editar
            </button>
            <form method="post" th:action="@{/pedidos/confirmar}">
                <button class="btn btn-confirmar" type="submit">
                    <i class="fas fa-paper-plane"></i> Confirmar Pedido
                </button>
            </form>
        </footer>
    </div>

    <script th:inline="javascript">
        function volverAlMenu() {
            window.history.back();
        }

        function cancelarPedido() {
            if(confirm('¿Estás seguro de cancelar este pedido?')) {
                // Cancelar pedido y limpiar borrador en el backend
                window.location.href = '/pedidos/cancelar';
            }
        }

        function editarPedido() {
            // Regresar a la vista de menú para la misma mesa
            const mesaId = /*[[${mesaId}]]*/ 1;
            window.location.href = '/mesero/menu?mesa=' + mesaId;
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Establecer fecha y hora actual del equipo en el resumen del pedido
            const fechaSpan = document.getElementById('fechaHoraPedido');
            if (fechaSpan) {
                const ahora = new Date();
                const opciones = { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' };
                fechaSpan.textContent = ahora.toLocaleString('es-CO', opciones);
            }
        });
    </script>
</body>
</html>