<div th:fragment="users">
	<section class="content-section">
		<div class="container-fluid">

			<!-- Encabezado -->
			<div class="section-header mb-4">
				<h2><i class="fas fa-users me-2"></i>Gestión de Usuarios</h2>
				<p class="text-muted">Administra los usuarios registrados del sistema</p>
			</div>

			<!-- Encabezado de tabla -->
			<div class="events-header mb-3">
				<div class="d-flex justify-content-between align-items-center mb-2">
					<h4 class="section-subtitle mb-0">
						Lista de Usuarios
						<span class="badge bg-primary" th:text="${users != null ? users.size() : 0}"></span>
					</h4>
					<div class="d-flex gap-2">
						<button type="button" class="btn btn-primary rounded-pill shadow-sm px-3" data-bs-toggle="modal"
							data-bs-target="#nuevoUsuarioModal">
							<i class="fas fa-user-plus me-2"></i>Agregar Usuario
						</button>
					</div>
				</div>
				<div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
					<div class="d-flex flex-wrap gap-2 align-items-center" style="flex:1; min-width:260px;">
						<div class="input-group" style="max-width: 320px;">
							<span class="input-group-text"><i class="fas fa-search"></i></span>
							<input type="text" id="userFilterInput" class="form-control" placeholder="Buscar por nombre, correo, rol...">
						</div>
						<div class="d-flex align-items-center gap-2">
							<label for="userStatusFilter" class="form-label mb-0">Estado:</label>
							<select id="userStatusFilter" class="form-select form-select-sm" style="min-width: 150px;">
								<option value="ALL">Todos</option>
								<option value="ACTIVO">Activos</option>
								<option value="INACTIVO">Inactivos</option>
							</select>
						</div>
					</div>
				</div>
			</div>

			<!-- Tabla de Usuarios -->
			<div class="table-responsive">
				<table class="table table-striped table-hover align-middle">
					<thead class="table-dark text-center">
						<tr>
							<th>Rol</th>
							<th>Nombre</th>
							<th>Apellido</th>
							<th>Correo</th>
							<th>Teléfono</th>
							<th>Estado</th>
							<th>Activar<br>Desactivar</th>
							<th>Turno</th>
							<th>Acciones</th>
						</tr>
					</thead>
					<tbody id="usersTableBody">
						<tr th:each="usuario : ${users}" class="text-center" data-row th:attr="data-status=${usuario.estado}">
							<td th:text="${usuario.rol != null ? usuario.rol.nombre : '—'}"></td>
							<td th:text="${usuario.nombre}"></td>
							<td th:text="${usuario.apellido}"></td>
							<td th:text="${usuario.correo}"></td>
							<td th:text="${usuario.telefono ?: 'N/A'}"></td>
							<td>
								<span th:class="${usuario.estado == 'ACTIVO'} ? 'badge bg-success' : 'badge bg-danger'"
									th:text="${usuario.estado}"></span>
							</td>
							<td>
								<a th:href="@{/users/toggle-status/{id}(id=${usuario.id})}"
									th:class="${usuario.estado=='ACTIVO'} ? 'btn btn-secondary btn-sm rounded-pill px-3' : 'btn btn-success btn-sm rounded-pill px-3'"
									th:title="${usuario.estado=='ACTIVO'} ? 'Desactivar' : 'Activar'">
									<i
										th:class="${usuario.estado=='ACTIVO'} ? 'fas fa-toggle-off' : 'fas fa-toggle-on'"></i>
								</a>
							</td>
							<td>
								<span th:if="${usuario.fecha != null}">
									<div th:text="${#temporals.format(usuario.fecha, 'dd/MM/yyyy')}"></div>
									<small th:text="${usuario.horaInicio} + ' - ' + ${usuario.horaFin}"></small>
								</span>
								<span th:if="${usuario.fecha == null}">—</span>
							</td>
							<td>
								<div class="d-inline-flex flex-wrap gap-2 justify-content-center">
									<!-- EDITAR: abre modal  -->
									<button type="button" class="btn btn-warning btn-sm rounded-pill px-3 btn-edit-user"
										data-bs-toggle="modal" data-bs-target="#editarUsuarioModal" th:attr="
										        data-user-id=${usuario.id},
										        data-user-nombre=${usuario.nombre},
										        data-user-apellido=${usuario.apellido},
										        data-user-correo=${usuario.correo},
										        data-user-telefono=${usuario.telefono},
										        data-user-direccion=${usuario.direccion},
										        data-user-estado=${usuario.estado},
										        data-user-rol=${usuario.rol != null ? usuario.rol.id : ''},
										        data-user-fecha=${usuario.fecha != null ? #temporals.format(usuario.fecha, 'yyyy-MM-dd') : ''},
										        data-user-horainicio=${usuario.horaInicio != null ? #temporals.format(usuario.horaInicio, 'HH:mm') : ''},
										        data-user-horafin=${usuario.horaFin != null ? #temporals.format(usuario.horaFin, 'HH:mm') : ''}"
										title="Editar">
										<i class="fas fa-edit"></i>
									</button>

									<!-- ELIMINAR: abre modal de confirmación -->
									<button type="button" class="btn btn-danger btn-sm rounded-pill px-3 btn-open-delete-modal"
										data-bs-toggle="modal" data-bs-target="#confirmDeleteUserModal"
										th:attr="data-user-id=${usuario.id}, data-user-nombre=${usuario.nombre + ' ' + usuario.apellido}">
										<i class="fas fa-trash"></i>
									</button>
								</div>
							</td>
						</tr>

						<tr th:if="${users == null or users.isEmpty()}">
							<td colspan="9" class="text-center py-4 text-muted">
								<i class="fas fa-users fa-2x mb-3"></i>
								<p>No hay usuarios registrados.</p>
								<button type="button" class="btn btn-primary mt-2" data-bs-toggle="modal"
									data-bs-target="#nuevoUsuarioModal">
									<i class="fas fa-user-plus me-2"></i>Agregar Primer Usuario
								</button>
							</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>

		<!-- Modal Nuevo Usuario -->
		<div class="modal fade" id="nuevoUsuarioModal" tabindex="-1" aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<form th:action="@{/users/save}" th:object="${newUser}" method="post">
						<div class="modal-header">
							<h5 class="modal-title"><i class="fas fa-user-plus me-2"></i>Nuevo Usuario</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
						</div>
						<div class="modal-body">
							<div class="row mb-3">
								<div class="col-md-6">
									<label class="form-label">Nombre *</label>
									<input type="text" class="form-control" th:field="*{nombre}" required>
								</div>
								<div class="col-md-6">
									<label class="form-label">Apellido *</label>
									<input type="text" class="form-control" th:field="*{apellido}" required>
								</div>
							</div>
							<div class="row mb-3">
								<div class="col-md-6">
									<label class="form-label">Correo *</label>
									<input type="email" class="form-control" th:field="*{correo}" required>
								</div>
								<div class="col-md-6">
									<label class="form-label">Contraseña *</label>
									<input type="password" class="form-control" th:field="*{clave}" required>
								</div>
							</div>
							<div class="row mb-3">
								<div class="col-md-6">
									<label class="form-label">Teléfono</label>
									<input type="tel" class="form-control" th:field="*{telefono}">
								</div>
								<div class="col-md-6">
									<label class="form-label">Dirección</label>
									<input type="text" class="form-control" th:field="*{direccion}">
								</div>
							</div>
							<div class="row mb-3">
								<div class="col-md-6">
									<label class="form-label">Estado</label>
									<select class="form-select" th:field="*{estado}">
										<option value="ACTIVO">Activo</option>
										<option value="INACTIVO">Inactivo</option>
									</select>
								</div>
								<div class="col-md-6">
									<label class="form-label">Rol *</label>
									<select class="form-select" th:field="*{rol.id}" required>
										<option value="" disabled selected>Selecciona un rol</option>
										<option th:each="rol : ${roles}" th:value="${rol.id}" th:text="${rol.nombre}">
										</option>
									</select>
								</div>
							</div>
							<div class="row mb-3">
								<div class="col-md-4">
									<label class="form-label">Fecha del turno</label>
									<input type="date" class="form-control" name="fecha">
								</div>
								<div class="col-md-4">
									<label class="form-label">Hora de inicio</label>
									<input type="time" class="form-control" name="horaInicio">
								</div>
								<div class="col-md-4">
									<label class="form-label">Hora de fin</label>
									<input type="time" class="form-control" name="horaFin">
								</div>
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
							<button type="submit" class="btn btn-primary"><i class="fas fa-save me-1"></i>Guardar
								Usuario</button>
						</div>
					</form>
				</div>
			</div>
		</div>

		<!-- Modal Editar Usuario -->
		<div class="modal fade" id="editarUsuarioModal" tabindex="-1" aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<form id="formEditarUsuario" th:action="@{/users/update}" method="post">
						<input type="hidden" name="id" id="edit-user-id">
						<div class="modal-header">
							<h5 class="modal-title"><i class="fas fa-user-edit me-2"></i>Editar Usuario</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
						</div>
						<div class="modal-body">
							<div class="row mb-3">
								<div class="col-md-6">
									<label class="form-label">Nombre *</label>
									<input type="text" class="form-control" name="nombre" id="edit-user-nombre"
										required>
								</div>
								<div class="col-md-6">
									<label class="form-label">Apellido *</label>
									<input type="text" class="form-control" name="apellido" id="edit-user-apellido"
										required>
								</div>
							</div>
							<div class="row mb-3">
								<div class="col-md-6">
									<label class="form-label">Correo *</label>
									<input type="email" class="form-control" name="correo" id="edit-user-correo"
										required>
								</div>
								<div class="col-md-6">
									<label class="form-label">Teléfono</label>
									<input type="tel" class="form-control" name="telefono" id="edit-user-telefono">
								</div>
							</div>
							<div class="row mb-3">
								<div class="col-md-6">
									<label class="form-label">Dirección</label>
									<input type="text" class="form-control" name="direccion" id="edit-user-direccion">
								</div>
								<div class="col-md-6">
									<label class="form-label">Rol *</label>
									<select class="form-select" name="rol.id" id="edit-user-rol" required>
										<option value="" disabled>Selecciona un rol</option>
										<option th:each="rol : ${roles}" th:value="${rol.id}" th:text="${rol.nombre}">
										</option>
									</select>
								</div>
							</div>
							<div class="row mb-3">
								<div class="col-md-6">
									<label class="form-label">Estado</label>
									<select class="form-select" name="estado" id="edit-user-estado">
										<option value="ACTIVO">Activo</option>
										<option value="INACTIVO">Inactivo</option>
									</select>
								</div>
								<div class="col-md-6">
									<label class="form-label">Contraseña (opcional)</label>
									<input type="password" class="form-control" name="clave"
										placeholder="Dejar en blanco si no la cambia">
								</div>
							</div>
							<div class="row mb-3">
								<div class="col-md-4">
									<label class="form-label">Fecha del turno</label>
									<input type="date" class="form-control" name="fecha" id="edit-user-fecha">
								</div>
								<div class="col-md-4">
									<label class="form-label">Hora de inicio</label>
									<input type="time" class="form-control" name="horaInicio" id="edit-user-horainicio">
								</div>
								<div class="col-md-4">
									<label class="form-label">Hora de fin</label>
									<input type="time" class="form-control" name="horaFin" id="edit-user-horafin">
								</div>
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
							<button type="submit" class="btn btn-primary"><i class="fas fa-save me-1"></i>Actualizar
								Usuario</button>
						</div>
					</form>
				</div>
			</div>
		</div>

		<!-- Modal Confirmar Eliminación -->
		<div class="modal fade" id="confirmDeleteUserModal" tabindex="-1" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title"><i class="fas fa-trash me-2"></i>Eliminar Usuario</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
					</div>
					<div class="modal-body">
						<p>¿Seguro que deseas eliminar al usuario <strong id="delete-user-name">NOMBRE</strong>?</p>
						<p class="text-muted">Esta acción no se puede deshacer.</p>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
						<a href="#" id="confirm-delete-link" class="btn btn-danger">
							<i class="fas fa-trash me-1"></i>Eliminar
						</a>
					</div>
				</div>
			</div>
		</div>
	</section>

	<!-- JavaScript para los modales -->
	<script>
		// Modal de edición
		document.querySelectorAll('.btn-edit-user').forEach(button => {

			button.addEventListener('click', function () {
				const userId = this.getAttribute('data-user-id');
				const userNombre = this.getAttribute('data-user-nombre');
				const userApellido = this.getAttribute('data-user-apellido');
				const userCorreo = this.getAttribute('data-user-correo');
				const userTelefono = this.getAttribute('data-user-telefono');
				const userDireccion = this.getAttribute('data-user-direccion');
				const userEstado = this.getAttribute('data-user-estado');
				const userRol = this.getAttribute('data-user-rol');
				const userFecha = this.getAttribute('data-user-fecha');
				const userHoraInicio = this.getAttribute('data-user-horainicio');
				const userHoraFin = this.getAttribute('data-user-horafin');

				document.getElementById('edit-user-id').value = userId;
				document.getElementById('edit-user-nombre').value = userNombre;
				document.getElementById('edit-user-apellido').value = userApellido;
				document.getElementById('edit-user-correo').value = userCorreo;
				document.getElementById('edit-user-telefono').value = userTelefono || '';
				document.getElementById('edit-user-direccion').value = userDireccion || '';
				document.getElementById('edit-user-estado').value = userEstado;
				document.getElementById('edit-user-rol').value = userRol;
				document.getElementById('edit-user-fecha').value = userFecha || '';
				document.getElementById('edit-user-horainicio').value = userHoraInicio || '';
				document.getElementById('edit-user-horafin').value = userHoraFin || '';
			});
		});

		// Modal de eliminación
		document.querySelectorAll('.btn-open-delete-modal').forEach(button => {
			button.addEventListener('click', function () {
				const userId = this.getAttribute('data-user-id');
				const userName = this.getAttribute('data-user-nombre');

				document.getElementById('delete-user-name').textContent = userName;
				document.getElementById('confirm-delete-link').href = `/users/delete/${userId}`;
			});
		});

		// Filtro por texto y estado
		(function(){
			const tbody = document.getElementById('usersTableBody');
			if (!tbody) return;
			const rows = Array.from(tbody.querySelectorAll('tr[data-row]'));
			const textInput = document.getElementById('userFilterInput');
			const statusSelect = document.getElementById('userStatusFilter');

			function getRowText(row){
				const tds = row.querySelectorAll('td');
				const rol = tds[0] ? (tds[0].innerText || '') : '';
				const nombre = tds[1] ? (tds[1].innerText || '') : '';
				const apellido = tds[2] ? (tds[2].innerText || '') : '';
				const correo = tds[3] ? (tds[3].innerText || '') : '';
				return (rol + ' ' + nombre + ' ' + apellido + ' ' + correo).toLowerCase();
			}

			function applyFilter(){
				const q = (textInput?.value || '').toLowerCase().trim();
				const status = (statusSelect?.value || 'ALL');

				rows.forEach(row => {
					const rowStatus = row.getAttribute('data-status') || '';
					const textMatch = !q || getRowText(row).includes(q);
					const statusMatch = status === 'ALL' || rowStatus === status;
					row.style.display = (textMatch && statusMatch) ? '' : 'none';
				});
			}

			if (textInput) textInput.addEventListener('input', applyFilter);
			if (statusSelect) statusSelect.addEventListener('change', applyFilter);
			applyFilter();
		})();
	</script>
</div>